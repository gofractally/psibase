name: Ubuntu builds

on:
  workflow_call:

jobs:
  build:
    name: Ubuntu ${{ matrix.ubuntu-version }} - Build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - builder-image: "ghcr.io/${{ github.repository_owner }}/psibase-builder-ubuntu-2204:72cf6b67cffeb1ed9b663f2d721649a61988cd80"
            ubuntu-version: "2204"
          - builder-image: "ghcr.io/${{ github.repository_owner }}/psibase-builder-ubuntu-2404:72cf6b67cffeb1ed9b663f2d721649a61988cd80"
            ubuntu-version: "2404"
    steps:
      - name: Timestamp
        id: ccache_cache_timestamp
        run: echo timestamp=`date -u +"%Y-%m-%d-%H-%M-%S"` >>$GITHUB_OUTPUT
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: false
          fetch-depth: 0
      - name: Preserve ccache
        uses: actions/cache@v3
        with:
          path: .caches
          key: $ubuntu-${{ matrix.ubuntu-version }}-caches-${{ steps.ccache_cache_timestamp.outputs.timestamp }}
          restore-keys: |
            $ubuntu-${{ matrix.ubuntu-version }}-caches-
      - name: Build
        run: bash ${GITHUB_WORKSPACE}/.github/scripts/build.sh ${GITHUB_WORKSPACE} ${{ matrix.builder-image }} ${{ matrix.ubuntu-version }}
      - name: Upload psidk-ubuntu-${{ matrix.ubuntu-version }}
        uses: actions/upload-artifact@v4
        with:
          name: psidk-ubuntu-${{ matrix.ubuntu-version }}
          path: build/psidk-ubuntu-${{ matrix.ubuntu-version }}.tar.gz
      - name: Upload psidk-book
        if: ${{ matrix.ubuntu-version == '2404' }}
        uses: actions/upload-artifact@v4
        with:
          name: psidk-book
          path: psidk-book.tar.gz
