# Plugin Permissions and Trust Assertions Report

This report lists all publicly-exposed functions for each plugin in the Psibase system, along with their trust-related assertions. Functions with no assertions are explicitly listed as such for completeness.

## Analysis Methodology

- **Publicly-exposed functions**: Functions defined in WIT interface files that can be called by other services or frontend applications
- **Trust assertions**: Authorization checks that restrict function access based on caller identity, trust levels, or whitelists
- **Assertion types**:
  - **Trust level assertions**: Using `psibase::define_trust!` macro with `assert_authorized()` calls
  - **Whitelist assertions**: Using `assert_authorized_with_whitelist()` or hardcoded whitelist checks
  - **Caller checks**: Direct checks on `get_sender()`, `get_active_app()`, etc.
  - **Admin checks**: Service-specific admin authorization patterns

## Plugin Functions and Trust Assertions

| Plugin                                                                                  | Function                      | Trust Assertions                                                             | Proposed                                                                                                                                 |
| --------------------------------------------------------------------------------------- | ----------------------------- | ---------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| **crypto**<br/>(Uses `psibase::define_trust!` with None/Low/High trust levels)          | `generate-unmanaged-keypair`  | None                                                                         |
|                                                                                         | `pub-from-priv`               | None                                                                         |
|                                                                                         | `to-der`                      | None                                                                         |
|                                                                                         | `sign`                        | High; assert_authorized_whitelist: ["transact", "auth-sig"]                  |
|                                                                                         | `sign-explicit`               | Low; assert_authorized_whitelist: ["auth-sig", "auth-invite"]                | None (no whitelist)                                                                                                                      |
|                                                                                         | `import-key`                  | Low; assert_authorized_whitelist: ["x-admin", "invite", "auth-sig"]          | ? called must have key                                                                                                                   |
| **auth**<br/>(Caller-based whitelisting)                                                | `set-logged-in-user`          | N/A; check_caller(&["accounts"])                                             | MAX; whitelist("accounts")                                                                                                               |
|                                                                                         | `log-out-user`                | N/A; check_caller(&["accounts"])                                             | MAX; whitelist("accounts")                                                                                                               |
|                                                                                         | `get-active-query-token`      | N/A; check_caller(&["host", "supervisor"])                                   | MAX; whitelist("host", "supervisor")                                                                                                     |
| **types**<br/>(No trust assertions)                                                     | `new`                         | N/A                                                                          | None                                                                                                                                     |
|                                                                                         | `get-service`                 | N/A                                                                          | None                                                                                                                                     |
|                                                                                         | `get-plugin`                  | N/A                                                                          | None                                                                                                                                     |
|                                                                                         | `get-intf`                    | N/A                                                                          | None                                                                                                                                     |
| **common**<br/>(Caller-based whitelisting)                                              | `post`                        | N/A; check_caller(&["host"])                                                 | MAX; whitelist("host") ?? consequences are low, but subj billing involved; terrible place to potentially cause a popup...                |
|                                                                                         | `post-graphql-get-json`       | N/A                                                                          | ditto                                                                                                                                    |
|                                                                                         | `post`                        | N/A                                                                          | ditto                                                                                                                                    |
|                                                                                         | `get-json`                    | N/A                                                                          | ditto                                                                                                                                    |
|                                                                                         | `get-sender`                  | N/A                                                                          | None                                                                                                                                     |
|                                                                                         | `get-receiver`                | N/A                                                                          | None                                                                                                                                     |
|                                                                                         | `get-app-url`                 | N/A                                                                          | None                                                                                                                                     |
|                                                                                         | `get-active-app`              | N/A                                                                          | None                                                                                                                                     |
|                                                                                         | `clear-buffers`               | N/A; check_caller(&["transact"])                                             | whitelist("transact")                                                                                                                    |
|                                                                                         | `flush-transactional-data`    | N/A; check_caller(&["transact"])                                             | whitelist("transact")                                                                                                                    |
| **prompt**<br/>(Caller-based checks)                                                    | `get-active-prompt`           | N/A; assert_eq!(get_sender(), "supervisor")                                  | MAX; whitelist("supervisor")                                                                                                             |
|                                                                                         | `prompt`                      | N/A                                                                          | None ?? this can alter client space/data but is another terrible place for a potential prompt                                            |
|                                                                                         | `get-context`                 | N/A                                                                          | whitelist(?"supervisor"?)                                                                                                                |
| **Supervisor**<br/>(No trust assertions - only bindings.rs present)                     |                               | N/A                                                                          | nothing needed here, right?                                                                                                              |
| **Accounts**<br/>(Mixed - admin checks, hardcoded restrictions, and whitelist patterns) | `is-logged-in`                | N/A                                                                          | None                                                                                                                                     |
|                                                                                         | `get-account`                 | N/A                                                                          | None                                                                                                                                     |
|                                                                                         | `set-auth-service`            | N/A; Client::get_sender() != "homepage"                                      | ?must be called from HomePage?                                                                                                           |
|                                                                                         | `get-current-user`            | N/A                                                                          | None                                                                                                                                     |
|                                                                                         | `login-direct`                | N/A; assert_caller_admin                                                     | one-off check; can this be maded shared? or no way to do that authoritatively outside of the app that needs the check?                   |
|                                                                                         | `decode-connection-token`     | N/A; assert_caller_admin                                                     | one-off                                                                                                                                  |
|                                                                                         | `get-connected-apps`          | N/A; assert(caller == "homepage")                                            | do we want this this way?, i.e., no one else can write a container app like HomePage?                                                    |
|                                                                                         | `import-account`              | N/A; assert_caller_admin                                                     | one-off                                                                                                                                  |
|                                                                                         | `get-all-accounts`            | N/A; assert_caller_admin                                                     | one-off                                                                                                                                  |
|                                                                                         | `get-auth-services`           | N/A; assert(Client::get_sender() == "supervisor")                            | MAX; whitelist("supervisor")                                                                                                             |
| **AuthSig**<br/>(Uses `psibase::define_trust!` with None/Low/High trust levels)         | `generate-unmanaged-keypair`  | None                                                                         |
|                                                                                         | `pub-from-priv`               | None                                                                         |
|                                                                                         | `to-der`                      | None                                                                         |
|                                                                                         | `sign`                        | High; assert_authorized_whitelist: ["transact"]                              |
|                                                                                         | `sign-explicit`               | Low; assert_authorized_whitelist: ["auth-invite"]                            | None                                                                                                                                     |
|                                                                                         | `import-key`                  | Low; assert_authorized_whitelist: ["accounts", "x-admin", "invite"]          |
|                                                                                         | `set-key`                     | High                                                                         |
| **Transact**<br/>(Supervisor-only access and hardcoded whitelists)                      | `hook-action-auth`            | N/A                                                                          |
|                                                                                         | `hook-actions-sender`         | N/A; hardcoded whitelist: ["staged-tx", "invite"]                            | whitelist("staged-tx", "invite")                                                                                                         |
|                                                                                         | `unhook-actions-sender`       | N/A                                                                          |
|                                                                                         | `hook-tx-transform-label`     | N/A; hardcoded whitelist: ["staged-tx"]                                      | whitelist("staged-tx")                                                                                                                   |
|                                                                                         | `add-action-to-transaction`   | N/A                                                                          | None                                                                                                                                     |
|                                                                                         | `set-snapshot-time`           | N/A                                                                          | None                                                                                                                                     |
|                                                                                         | `start-tx`                    | N/A; assert_from_supervisor()                                                | MAX; whitelist ("supervisor")                                                                                                            |
|                                                                                         | `finish-tx`                   | N/A; assert_from_supervisor()                                                | MAX; whitelist("supervisor")                                                                                                             |
|                                                                                         | `get-query-token`             | N/A; assert(Client::get_sender() == "host")                                  | MAX; whitelist("host")                                                                                                                   |
| **Permissions**<br/>(Admin checks and app-based authorization)                          | `get-context`                 | N/A; assert_admin()                                                          | one-off; share?                                                                                                                          |
|                                                                                         | `approve`                     | N/A; assert_admin()                                                          | one-off; share?                                                                                                                          |
|                                                                                         | `set-allowed-callers`         | N/A; assert_eq!(get_sender(), get_active_app())                              | one-off                                                                                                                                  |
|                                                                                         | `is-authorized`               | N/A; Complex authorization logic (trust levels, whitelists, user validation) | review with James                                                                                                                        |
| **Evaluations**<br/>(Owner/service-based access control)                                | _Functions with trust checks_ | N/A; check_app_origin() - allows owner or evaluations service                |
| **Tokens**<br/>(Sender-based authorization for token operations)                        | `delBalConf`                  | N/A; Table-level authorization via get_sender()                              | Medium                                                                                                                                   |
|                                                                                         | `debit`                       | N/A; Table-level authorization via get_sender()                              | Medium                                                                                                                                   |
|                                                                                         | `reject`                      | N/A; Table-level authorization via get_sender()                              | Medium                                                                                                                                   |
|                                                                                         | _Various token operations_    | N/A; check(token.nft_holder() == get_sender()) for untradeable tokens        | one-offs                                                                                                                                 |
| **Supervisor**<br/>(No trust assertions)                                                | All functions                 | N/A                                                                          | confirm all calls originate from Host?                                                                                                   |
| **AuthAny**<br/>(No trust assertions)                                                   | `on_user_auth_claim`          | N/A                                                                          | we could say whitelist("transact"), but since this is a hook, we'd only b e setting a precedent, not globally enforcing anything, right? |
|                                                                                         | `on_user_auth_proof`          | N/A                                                                          |
| **AuthDelegate**<br/>(No trust assertions)                                              | `set-owner`                   | N/A                                                                          | ?? High; whitelist(sender)                                                                                                               |
|                                                                                         | `new-account`                 | N/A                                                                          | ?? High; whitelist(sender)?                                                                                                              |
| **Producers**<br/>(No trust assertions)                                                 | `set-cft-consensus`           | N/A                                                                          | one-off; handled by requiring producers-strong multi-sig                                                                                 |
|                                                                                         | `set-bft-consensus`           | N/A                                                                          |
|                                                                                         | `set-producers`               | N/A                                                                          |
| **SetCode**<br/>(No trust assertions)                                                   | `set-service-code`            | N/A                                                                          | one-off based on admin of the code being set?                                                                                            |
|                                                                                         | `stage-service-code`          | N/A                                                                          | ?                                                                                                                                        |
| **StagedTx**<br/>(No trust assertions)                                                  | `set-propose-latch`           | N/A                                                                          |
|                                                                                         | `propose`                     | N/A                                                                          |
|                                                                                         | `remove`                      | N/A                                                                          |
|                                                                                         | `accept`                      | N/A                                                                          |
|                                                                                         | `reject`                      | N/A                                                                          |
|                                                                                         | `execute`                     | N/A                                                                          |
| **HttpServer**<br/>(C++ service - no plugin functions)                                  | No plugin functions           |
| **CpuLimit**<br/>(C++ service - no plugin functions)                                    | No plugin functions           |
| **VerifySig**<br/>(C++ service - no plugin functions)                                   | No plugin functions           |
| **Aes**<br/>(No trust assertions)                                                       | `encrypt (with-password)`     | None                                                                         | No trust definition needed.                                                                                                              |
|                                                                                         | `decrypt (with-password)`     | None                                                                         |
|                                                                                         | `encrypt (with-key)`          | None                                                                         |
|                                                                                         | `decrypt (with-key)`          | None                                                                         |
| **Base64**<br/>(No trust assertions)                                                    | `encode (url)`                | N/A                                                                          | No trust definition needed                                                                                                               |
|                                                                                         | `decode (url)`                | N/A                                                                          |
|                                                                                         | `encode (standard)`           | N/A                                                                          |
|                                                                                         | `decode (standard)`           | N/A                                                                          |
| **Branding**<br/>(No trust assertions)                                                  | `set-network-name`            | N/A                                                                          | MAX; whitelist("config")                                                                                                                 |
|                                                                                         | `set-logo`                    | N/A                                                                          | MAX; whitelist("config")                                                                                                                 |
|                                                                                         | `get-network-name`            | N/A                                                                          | None                                                                                                                                     |
| **BrotliCodec**<br/>(No trust assertions)                                               | `compress`                    | N/A                                                                          | No trust definition needed                                                                                                               |
|                                                                                         | `decompress`                  | N/A                                                                          |
| **Chainmail**<br/>(No trust assertions)                                                 | `get-msgs`                    | N/A                                                                          | None                                                                                                                                     |
|                                                                                         | `get-archived-msgs`           | N/A                                                                          | None                                                                                                                                     |
|                                                                                         | `get-saved-msgs`              | N/A                                                                          | None                                                                                                                                     |
|                                                                                         | `send`                        | N/A                                                                          | High; whitelist(receiver)                                                                                                                |
|                                                                                         | `archive`                     | N/A                                                                          | Medium                                                                                                                                   |
|                                                                                         | `save`                        | N/A                                                                          | Medium                                                                                                                                   |
| **ClientData**<br/>(No trust assertions)                                                | `get`                         | N/A                                                                          | Low but awkward place for a prompt                                                                                                       |
|                                                                                         | `set`                         | N/A                                                                          | Low but awkward place for a prompt                                                                                                       |
|                                                                                         | `delete`                      | N/A                                                                          | Low but awkward place for a prompt                                                                                                       |
| **Config**<br/>TODO: consider the plugin fns called by these                            | `upload-network-logo`         | N/A                                                                          | MAX                                                                                                                                      |
|                                                                                         | `set-network-name`            | N/A                                                                          | MAX                                                                                                                                      |
|                                                                                         | `set-account-sources`         | N/A                                                                          | MAX                                                                                                                                      |
|                                                                                         | `set-snapshot-time`           | N/A                                                                          | MAX                                                                                                                                      |
|                                                                                         | `set-cft-consensus`           | N/A                                                                          | MAX                                                                                                                                      |
|                                                                                         | `set-bft-consensus`           | N/A                                                                          | MAX                                                                                                                                      |
|                                                                                         | `set-producers`               | N/A                                                                          | MAX                                                                                                                                      |
| **Fractals**<br/>(No trust assertions)                                                  | `create-fractal`              | N/A                                                                          | Medium                                                                                                                                   |
|                                                                                         | `set-schedule`                | N/A                                                                          | High                                                                                                                                     |
|                                                                                         | `start`                       | N/A                                                                          | High                                                                                                                                     |
|                                                                                         | `close-eval`                  | N/A                                                                          | High                                                                                                                                     |
|                                                                                         | `join`                        | N/A                                                                          | Medium                                                                                                                                   |
|                                                                                         | `attest`                      | N/A                                                                          | Medium                                                                                                                                   |
|                                                                                         | `propose`                     | N/A                                                                          | Medium                                                                                                                                   |
|                                                                                         | `register`                    | N/A                                                                          | Medium                                                                                                                                   |
|                                                                                         | `unregister`                  | N/A                                                                          | Medium                                                                                                                                   |
|                                                                                         | `get-group-users`             | N/A                                                                          | None                                                                                                                                     |
|                                                                                         | `get-proposal`                | N/A                                                                          | None                                                                                                                                     |
| **Identity**<br/>(No trust assertions)                                                  | `attest-identity-claim`       | N/A                                                                          | Medium                                                                                                                                   |
|                                                                                         | `summary`                     | N/A                                                                          | None                                                                                                                                     |
| **Invite**<br/>(No trust assertions)                                                    | `generate-invite`             | N/A                                                                          | Medium                                                                                                                                   |
|                                                                                         | `delete-invite`               | N/A                                                                          | Medium?                                                                                                                                  |
|                                                                                         | `decode-invite`               | N/A                                                                          | None?                                                                                                                                    |
|                                                                                         | `accept-with-new-account`     | N/A                                                                          | Medium                                                                                                                                   |
|                                                                                         | `accept`                      | N/A                                                                          | Medium                                                                                                                                   |
|                                                                                         | `reject`                      | N/A                                                                          | Medium                                                                                                                                   |
|                                                                                         | `deserialize`                 | N/A                                                                          | None                                                                                                                                     |
| **Kdf**<br/>(No trust assertions)                                                       | `derive-key`                  | N/A                                                                          | None                                                                                                                                     |
| **Nft**<br/>(C++ service - no plugin functions)                                         | No plugin functions           |
| **Nop**<br/>(C++ service - no plugin functions)                                         | No plugin functions           |
| **Packages**<br/>(No trust assertions)                                                  | `resolve`                     | N/A                                                                          | None                                                                                                                                     |
|                                                                                         | `build-transactions`          | N/A                                                                          |
|                                                                                         | `propose-install`             | N/A                                                                          |
|                                                                                         | `set-account-sources`         | N/A                                                                          | medium; whitelist("config")                                                                                                              |
|                                                                                         | `push-data`                   | N/A                                                                          |
| **Profiles**<br/>(No trust assertions)                                                  | `set` (contacts)              | N/A                                                                          |
|                                                                                         | `remove` (contacts)           | N/A                                                                          |
|                                                                                         | `get` (contacts)              | N/A                                                                          |
|                                                                                         | `set-profile` (api)           | N/A                                                                          |
|                                                                                         | `upload-avatar` (api)         | N/A                                                                          |
|                                                                                         | `remove-avatar` (api)         | N/A                                                                          |
| **Registry**<br/>(No trust assertions)                                                  | `set-metadata`                | N/A                                                                          |
|                                                                                         | `publish`                     | N/A                                                                          |
|                                                                                         | `unpublish`                   | N/A                                                                          |
| **SimpleService**<br/>(C++ service - no plugin functions)                               | No plugin functions           |
| **Sites**<br/>(No trust assertions)                                                     | `upload`                      | N/A                                                                          |
|                                                                                         | `upload-encoded`              | N/A                                                                          |
|                                                                                         | `upload-tree`                 | N/A                                                                          |
|                                                                                         | `remove`                      | N/A                                                                          |
|                                                                                         | `enable-spa`                  | N/A                                                                          |
|                                                                                         | `set-csp`                     | N/A                                                                          |
|                                                                                         | `delete-csp`                  | N/A                                                                          |
|                                                                                         | `set-cache-mode`              | N/A                                                                          |
| **Subgroups**<br/>(C++ service - no plugin functions)                                   | No plugin functions           |
| **TokenStream**<br/>(Uses `psibase::define_trust!` with Low/Medium/High trust levels)   | `create`                      | Medium                                                                       |
|                                                                                         | `deposit`                     | High                                                                         |
|                                                                                         | `claim`                       | High                                                                         |
|                                                                                         | `delete`                      | High                                                                         |
| **WebCrypto**<br/>(No trust assertions)                                                 | `sign`                        | N/A                                                                          | whitelist?                                                                                                                               |
|                                                                                         | `sign-explicit`               | N/A                                                                          | whitelist?                                                                                                                               |
|                                                                                         | `import-key`                  | N/A                                                                          | whitelist?                                                                                                                               |
| **Workshop**<br/>(No trust assertions)                                                  | `create-app`                  | N/A                                                                          |
|                                                                                         | `set-app-metadata`            | N/A                                                                          |
|                                                                                         | `publish-app`                 | N/A                                                                          |
|                                                                                         | `unpublish-app`               | N/A                                                                          |
|                                                                                         | `upload`                      | N/A                                                                          |
|                                                                                         | `upload-tree`                 | N/A                                                                          |
|                                                                                         | `enable-spa`                  | N/A                                                                          |
|                                                                                         | `set-csp`                     | N/A                                                                          |
|                                                                                         | `delete-csp`                  | N/A                                                                          |
|                                                                                         | `remove`                      | N/A                                                                          |
|                                                                                         | `set-cache-mode`              | N/A                                                                          |
|                                                                                         | `set-service-code`            | N/A                                                                          |
|                                                                                         | `send`                        | N/A                                                                          |
|                                                                                         | `archive`                     | N/A                                                                          |
|                                                                                         | `save`                        | N/A                                                                          |
| **XAdmin**<br/>(No plugin interface)                                                    | No plugin functions           |

## Summary

- **Plugins using `define_trust!` framework**: 3 plugins use the formal trust level system:
  - **crypto** (Host): None/Low/High trust levels
  - **AuthSig** (System): None/Low/High trust levels
  - **TokenStream** (User): Low/Medium/High trust levels
- **Plugins with alternative auth mechanisms**: Several plugins implement custom authorization checks:
  - **auth**, **common**, **prompt**, **transact**: Use check_caller() or sender checks (marked as "N/A; <check description>")
  - **Accounts**: Uses assert_caller_admin and hardcoded caller checks
  - **Permissions**: Uses assert_admin() and app-based checks
  - **Tokens**, **Evaluations**: Use table-level or service-based authorization
- **Plugins with no authorization**: Majority of user plugins have no explicit authorization checks (marked as "N/A")
- **C++ services**: Several plugins are C++ services without plugin interfaces (Nft, Nop, SimpleService, Subgroups, XAdmin)
- **Total plugins analyzed**: 40+ plugins across system and user packages
- **Functions audited**: Each publicly-exposed function is listed individually with its specific trust level or authorization mechanism

### Trust Level Notation

- **None/Low/Medium/High**: Function uses `assert_authorized()` with the specified trust level from `define_trust!` macro
- **[Level]; assert_authorized_whitelist: [...]**: Function uses `assert_authorized_with_whitelist()` with specified trust level and whitelist
- **N/A**: Function does not use the `assert_authorized*()` framework
- **N/A; [description]**: Function has custom authorization checks but doesn't use the trust framework

This report provides a comprehensive audit foundation with all publicly-exposed functions individually listed and their authorization mechanisms clearly distinguished.
