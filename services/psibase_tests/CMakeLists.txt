enable_testing()

function(service name suffix)
    add_executable(${name}${suffix} ${ARGN})
    target_include_directories(${name}${suffix} PUBLIC include)
    target_link_libraries(${name}${suffix} services_system${suffix} services_user${suffix} services_test psibase-service-simple-malloc${suffix} )
    set_target_properties(${name}${suffix} PROPERTIES RUNTIME_OUTPUT_DIRECTORY ${ROOT_BINARY_DIR})
    if(TEST_GENERATE_SCHEMA)
        psibase_schema(${name}${suffix})
    endif()
endfunction()

function(add suffix)
    service(TestClock "${suffix}" src/TestClock.cpp)
    service(TestKV "${suffix}" src/TestKV.cpp)
    service(TestMemo "${suffix}" src/TestMemo.cpp)
    service(TestServiceEntry "${suffix}" src/TestServiceEntry.cpp)
    service(TestTable "${suffix}" src/TestTable.cpp)

    service(AbortService "${suffix}" src/AbortService.cpp)
    service(EmitEvents "${suffix}" src/EmitEvents.cpp)
    service(RemoveCode "${suffix}" src/RemoveCode.cpp)
    service(SubjectiveDb "${suffix}" src/SubjectiveDb.cpp)
    service(NotifyService "${suffix}" src/NotifyService.cpp)

    set(TEST_GENERATE_SCHEMA 1)
    service(MockCpuLimit "${suffix}" src/MockCpuLimit.cpp)
    service(PSubjectiveService "${suffix}" src/ParallelSubjectiveService.cpp)
    service(CounterService "${suffix}" src/CounterService.cpp)
    service(AsyncQueryService "${suffix}" src/AsyncQueryService.cpp)
    service(SubjectiveCounterService "${suffix}" src/SubjectiveCounterService.cpp)
    service(KeepSocketService "${suffix}" src/KeepSocketService.cpp)
    service(SocketListService "${suffix}" src/SocketListService.cpp)
endfunction(add)

add_library(services_test INTERFACE)
target_include_directories(services_test INTERFACE ../psibase_tests ../psibase_tests/include)

if(DEFINED IS_WASM)
    conditional_add()
endif()

add_subdirectory(test)

set(CMAKE_EXPORT_COMPILE_COMMANDS on)
